<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="publisher" content="Jonathan Robert Pool">
    <meta name="creator" content="Jonathan Robert Pool">
    <meta name="keywords" content="report,accessibility,a11y">
    <title>Progress | Kilotest</title>
    <link rel="stylesheet" href="/kilotest/style.css">
  </head>
  <body>
    <main>
      <h1>Kilotest progress</h1>
      <div id="status">
        <p>This is job __jobID__</p>
        <p>Testing is starting now</p>
      </div>
      <script>
        (function(){
          const statusDiv = document.getElementById('status');
          // Define the URL of the event source for this job.
          const eventSource = new EventSource('/kilotest/events/__jobID__');
          // When the event source sends a message:
          eventSource.onmessage = event => {
            try {
              // Get its data object, with eventType and payload properties.
              const eventData = JSON.parse(event.data);
              const {eventType, payload} = eventData;
              // If the event is the start of the job:
              if (eventType === 'jobStart') {
                // Add a paragraph with the Testaro start message.
                const startedPar = document.createElement('p');
                startedPar.textContent = 'Testing started';
                statusDiv.appendChild(startedPar);
              }
              // Otherwise, if the event is a tool or test start:
              else if (eventType === 'progress' && payload) {
                // Add a paragraph with a progress message based on the payload property.
                const progressPar = document.createElement('p');
                const {type, which} = payload;
                const scope = type === 'test' ? 'tool' : type;
                progressPar.innerHTML = `Starting tests of ${scope} <strong>${which}</strong>`;
                statusDiv.appendChild(progressPar);
              }
              // Otherwise, if the event is the end of the job:
              else if (eventType === 'digestDone') {
                // Fetch the digest and replace the page.
                fetch(payload.url, {credentials: 'same-origin'})
                .then(response => response.text())
                .then(digestHTML => {
                  document.open();
                  document.write(digestHTML);
                  document.close();
                }).catch(error => {
                  const errorDiv = document.createElement('div');
                  errorDiv.textContent = `Failed to fetch final report: ${error.message}`;
                  statusDiv.appendChild(errorDiv);
                });
                eventSource.close();
              } else if (eventType === 'error') {
                const errorDiv = document.createElement('div');
                errorDiv.textContent = `[error] ${eventData.message || 'unknown error'}`;
                statusDiv.appendChild(errorDiv);
                eventSource.close();
              }
            } catch (error) {}
          };
        })();
      </script>
    </main>
  </body>
</html>
